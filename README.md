# Prohesis — Backend & API Bundle

This bundle contains the missing backend files for your Prohesis prediction market:
- Prisma client singleton
- API routes for markets, bets, payouts, users, leaderboard
- Onchain provider utilities (viem/wagmi-compatible helpers)
- Read/Write onchain function helpers
- Sample `.env.example`
- Prisma schema

## Usage

1) Copy these files into your repo (preserving paths).
2) Create and fill `.env` based on `.env.example`.
3) Install deps:
```bash
npm install @prisma/client prisma zod @tanstack/react-query
```
4) Generate Prisma client & migrate:
```bash
npx prisma generate
npx prisma migrate dev --name init
```
5) Run dev:
```bash
npm run dev
```

## API Routes

All routes live under `/api/*` and return JSON.

- `GET /api/markets` — list markets (with pagination & filters)
- `POST /api/markets` — create market (off-chain record)
- `GET /api/bets?marketId=...` — list bets for a market
- `POST /api/bets` — add a bet record (after on-chain tx succeed)
- `POST /api/payouts` — add payout record
- `GET /api/leaderboard` — top users by total_staked


## Testing & CI

Local development:

1. Create `.env` from `.env.example` and ensure `DATABASE_URL` points to your dev Postgres.
2. Generate Prisma client and run migrations:

```bash
npx prisma generate
npx prisma migrate dev --name add_market_resolution_fields
```

3. Start dev server with optional dev API enabled:

```bash
# Enable dev-only APIs (if needed)
ENABLE_DEV_API=true npm run dev
```

E2E / Integration tests:

Run the mocha E2E test locally (dev server must be running):

```bash
BASE_URL=http://localhost:3000 TEST_USER=0x0000000000000000000000000000000000000001 npm run test:e2e
```

CI notes:

- The GitHub Actions workflow `migrate-and-deploy.yml` contains optional jobs `integration_smoke` and `e2e_test`. To enable them, set the `DATABASE_URL` secret in your repository and the jobs will run after migrations.
- `integration_smoke` runs `scripts/integration-smoke.mjs` to prepare DB state from on-chain factory data (if available).
- `e2e_test` runs the mocha E2E test which uses Prisma to set up a payout and validates the `/api/payouts/validate` behavior.

Automation helpers
------------------
Two small helper scripts were added under `scripts/` to make setting up local and CI secrets easier:

- `scripts/generate-env.sh` - generates a secure `.env.local` with autogenerated `NEXTAUTH_SECRET`, `SYNC_TOKEN`, and `ADMIN_PASS`. You should edit `DATABASE_URL`, `SEPOLIA_RPC_URL`, and `NEXT_PUBLIC_FACTORY_CONTRACT` afterwards.

- `scripts/push-github-secrets.sh` - helps push secrets to GitHub Actions using the GitHub CLI (`gh`). The script generates `NEXTAUTH_SECRET`, `SYNC_TOKEN`, and `ADMIN_PASS` automatically and prompts you to paste values for `DATABASE_URL`, `SEPOLIA_RPC_URL`, and `NEXT_PUBLIC_FACTORY_CONTRACT`. Run `gh auth login` first and have repo admin access.

Usage examples:

```bash
# create a local .env.local (recommended for local dev; not committed)
./scripts/generate-env.sh

# push secrets interactively to GitHub (requires gh CLI and repo admin)
./scripts/push-github-secrets.sh
```

